You are analyzing a customer conversation to extract situational context and customer data.

{% if schema_mask %}
# Customer Data Schema (Available Fields)

The following customer data fields are defined for this agent:
{% for key, entry in schema_mask.variables.items() %}
- {{ key }}: {{ entry.type }} ({{ entry.scope }}) {% if entry.exists %}[HAS VALUE]{% else %}[EMPTY]{% endif %}{% if entry.display_name %} - {{ entry.display_name }}{% endif %}

{% endfor %}
{% endif %}

{% if glossary %}
# Domain Glossary

Business-specific terms to use:
{% for term, item in glossary.items() %}
- **{{ item.term }}**: {{ item.definition }}{% if item.usage_hint %}
  Usage: {{ item.usage_hint }}{% endif %}

{% endfor %}
{% endif %}

{% if conversation_window %}
# Conversation History

{% for turn in conversation_window %}
{{ turn.role }}: {{ turn.content }}
{% endfor %}
{% endif %}

# Current Message

User: {{ message }}

# Task

Analyze this message and extract:

1. **Language detection**: ISO 639-1 code (e.g., "en", "es", "fr")
2. **Intent evolution**: Has the user's intent changed from previous? What's the new intent?
3. **Topic**: Current conversation topic classification
4. **Sentiment and tone**: Overall sentiment (positive/neutral/negative/frustrated), tone, and frustration level
5. **Urgency**: How urgent is this message? (low/normal/high/critical)
6. **Scenario signal**: What does the user want to do? (start/continue/exit/pause/cancel/unknown)
7. **Situation facts**: Key facts about the current situation (like mini rules)
8. **Candidate variables**: Extract values for schema fields from the message

## Extraction Rules

- For **candidate_variables**, only extract fields that appear in the Customer Data Schema above
- Use the exact field name (key) from the schema
- Set **scope** to match the schema entry
- Set **is_update** to true if the schema shows [HAS VALUE] and user is changing it
- Set **is_update** to false if the schema shows [EMPTY] or user is providing initial value

## Response Format

Respond with JSON matching this structure:

```json
{
  "language": "en",
  "previous_intent_label": "{{ previous_intent_label }}",
  "intent_changed": true,
  "new_intent_label": "refund_request",
  "new_intent_text": "User wants to request a refund",
  "topic": "refund",
  "topic_changed": false,
  "tone": "frustrated",
  "sentiment": "frustrated",
  "frustration_level": "medium",
  "urgency": "high",
  "scenario_signal": "continue",
  "situation_facts": [
    "User ordered product #12345",
    "Product arrived damaged",
    "User wants refund, not replacement"
  ],
  "candidate_variables": {
    "order_id": {
      "value": "12345",
      "scope": "CASE",
      "is_update": false
    },
    "issue_type": {
      "value": "damaged_product",
      "scope": "CASE",
      "is_update": false
    }
  }
}
```

## Field Guidelines

- **sentiment**: One of "positive", "neutral", "negative", "frustrated"
- **urgency**: One of "low", "normal", "high", "critical"
  - low: No time pressure
  - normal: Standard request
  - high: Needs prompt attention (e.g., "ASAP", "urgent")
  - critical: Emergency situation requiring immediate action
- **scenario_signal**: One of "start", "continue", "exit", "pause", "cancel", "unknown"
  - start: User wants to begin a new process
  - continue: Normal conversation flow
  - exit: User wants to leave/end the conversation
  - pause: User wants to pause temporarily
  - cancel: User wants to abort/cancel current process
  - unknown: Unclear what user wants

## Important Notes

- Only extract variables that are explicitly mentioned or clearly implied in the message
- Use business terminology from the glossary when describing intents and facts
- Be conservative with frustration detection (only mark medium/high if clear indicators)
- Leave candidate_variables empty {} if no schema fields are mentioned
